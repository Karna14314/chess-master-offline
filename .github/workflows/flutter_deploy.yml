name: Deploy to Google Play (Internal Track)

on:
  push:
    branches:
      - master

# Cancel any in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    name: Build & Deploy AAB
    runs-on: ubuntu-latest
    
    steps:
      # ───────────────────────────────────────────────
      # 1. Checkout the repository
      # ───────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ───────────────────────────────────────────────
      # 2. Set up Java (required for Android/Gradle)
      # ───────────────────────────────────────────────
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ───────────────────────────────────────────────
      # 3. Install Flutter SDK with caching
      # ───────────────────────────────────────────────
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.1'
          channel: 'stable'
          cache: true
          cache-key: 'flutter-:os:-:channel:-:version:-:arch:-:hash:'
          cache-path: '${{ runner.tool_cache }}/flutter/:channel:-:version:-:arch:'

      # ───────────────────────────────────────────────
      # 4. Cache Pub dependencies
      # ───────────────────────────────────────────────
      - name: Cache Pub dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool/
          key: pub-cache-${{ runner.os }}-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            pub-cache-${{ runner.os }}-

      # ───────────────────────────────────────────────
      # 5. Cache Gradle dependencies
      # ───────────────────────────────────────────────
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('android/gradle/wrapper/gradle-wrapper.properties', 'android/build.gradle.kts', 'android/app/build.gradle.kts') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      # ───────────────────────────────────────────────
      # 6. Install dependencies
      # ───────────────────────────────────────────────
      - name: Install dependencies
        run: flutter pub get

      # ───────────────────────────────────────────────
      # 7. Decode the Android Keystore from secrets
      # ───────────────────────────────────────────────
      - name: Decode Android Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/keystore.jks
          echo "Keystore decoded successfully"
          ls -la android/app/keystore.jks

      # ───────────────────────────────────────────────
      # 8. Build Release AAB
      # ───────────────────────────────────────────────
      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          KEYSTORE_FILE: app/keystore.jks
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
        run: |
          echo "Building AAB with versionCode=${{ github.run_number }}"
          flutter build appbundle --release --build-number=${{ github.run_number }}

      # ───────────────────────────────────────────────
      # 9. Upload AAB as build artifact (for debugging)
      # ───────────────────────────────────────────────
      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-aab-${{ github.run_number }}
          path: build/app/outputs/bundle/release/app-release.aab
          retention-days: 30

      # ───────────────────────────────────────────────
      # 10. Deploy to Google Play Internal Track
      # ───────────────────────────────────────────────
      - name: Deploy to Google Play (Internal Testing)
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.PLAY_STORE_JSON_KEY }}
          packageName: com.karna.chessmaster
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal
          status: completed
          whatsNewDirectory: distribution/whatsnew
        continue-on-error: false

      # ───────────────────────────────────────────────
      # 11. Post-deploy summary
      # ───────────────────────────────────────────────
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **App** | ChessMaster Offline |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package** | com.karna.chessmaster |" >> $GITHUB_STEP_SUMMARY
          echo "| **Track** | Internal Testing |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
